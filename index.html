<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>TaskWhisper - Voice Memo Email Scheduler</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      @keyframes pulse {
        0%,
        100% {
          opacity: 1;
        }
        50% {
          opacity: 0.5;
        }
      }
      .animate-pulse {
        animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
      }
      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }
      .animate-spin {
        animation: spin 1s linear infinite;
      }
    </style>
  </head>
  <body>
    <div id="root"></div>

    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script type="text/babel">
          const { useState, useRef, useEffect } = React;

          function TaskWhisper() {
            const [isRecording, setIsRecording] = useState(false);
            const [memos, setMemos] = useState([]);
            const [currentTranscript, setCurrentTranscript] = useState('');
            const [isEditingTranscript, setIsEditingTranscript] = useState(false);
            const [userEmail, setUserEmail] = useState('');
            const [scheduleDate, setScheduleDate] = useState('');
            const [scheduleTime, setScheduleTime] = useState('09:00');
            const [notificationMethod, setNotificationMethod] = useState(['email']);
            const [phoneNumber, setPhoneNumber] = useState('');
            const [recordingTime, setRecordingTime] = useState(0);
            const [isDarkMode, setIsDarkMode] = useState(false);
            const [showToast, setShowToast] = useState(false);
            const [scheduleSuccess, setScheduleSuccess] = useState(false);
            const [isTranscribing, setIsTranscribing] = useState(false);
            const [backendError, setBackendError] = useState(null);
            const [claudeAnalysis, setClaudeAnalysis] = useState(null);
            const [isAnalyzing, setIsAnalyzing] = useState(false);

            const timerRef = useRef(null);
            const scheduleRef = useRef(null);
            const mediaRecorderRef = useRef(null);
            const audioChunksRef = useRef([]);

            const API_URL = 'https://taskwhisper-backend-production.up.railway.app';

            useEffect(() => {
              return () => {
                if (timerRef.current) clearInterval(timerRef.current);
              };
            }, []);

            const startRecording = async () => {
              try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorderRef.current = new MediaRecorder(stream);
                audioChunksRef.current = [];

                mediaRecorderRef.current.ondataavailable = (event) => {
                  audioChunksRef.current.push(event.data);
                };

                mediaRecorderRef.current.onstop = () => {
                  const audioBlob = new Blob(audioChunksRef.current, { type: 'audio/webm' });
                  stream.getTracks().forEach(track => track.stop());
                  transcribeAudio(audioBlob);
                };

                mediaRecorderRef.current.start();
                setIsRecording(true);
                setRecordingTime(0);
                setBackendError(null);

                timerRef.current = setInterval(() => {
                  setRecordingTime(prev => prev + 1);
                }, 1000);
              } catch (err) {
                console.error('Microphone error:', err);
                setBackendError('Microphone access denied. Please allow microphone access and try again.');
              }
            };

            const stopRecording = () => {
              if (isRecording) {
                setIsRecording(false);
                if (timerRef.current) {
                  clearInterval(timerRef.current);
                  timerRef.current = null;
                }
                if (mediaRecorderRef.current && mediaRecorderRef.current.state !== 'inactive') {
                  mediaRecorderRef.current.stop();
                }
              }
            };

            const transcribeAudio = async (audioBlob) => {
              console.log('=== STARTING TRANSCRIPTION ===');
              setIsTranscribing(true);
              setBackendError(null);
              setClaudeAnalysis(null);

              try {
                const formData = new FormData();
                formData.append('audio', audioBlob, 'recording.webm');

                const response = await fetch(`${API_URL}/api/transcribe`, {
                  method: 'POST',
                  body: formData,
                });

                if (!response.ok) {
                  throw new Error(`Backend error: ${response.status}`);
                }

                const data = await response.json();
                console.log('=== TRANSCRIPTION COMPLETE ===', data);

                if (data.success) {
                  setCurrentTranscript(data.transcript);
                  setIsTranscribing(false);

                  // Set default to 24 hours from now
                  const tomorrow = new Date();
                  tomorrow.setHours(tomorrow.getHours() + 24);
                  const dateStr = `${tomorrow.getFullYear()}-${String(tomorrow.getMonth() + 1).padStart(2, '0')}-${String(tomorrow.getDate()).padStart(2, '0')}`;
                  setScheduleDate(dateStr);

                  if (data.mock) {
                    setBackendError('‚ö†Ô∏è Using mock transcription.');
                  }

                  // Call Claude for analysis
                  callClaude(data.transcript);

                  setTimeout(() => scheduleRef.current?.scrollIntoView({ behavior: 'smooth' }), 300);
                } else {
                  throw new Error('Transcription failed');
                }

              } catch (error) {
                console.error('=== TRANSCRIPTION ERROR ===', error);
                setIsTranscribing(false);
                setBackendError(`Failed to transcribe: ${error.message}`);
              }
            };

            const callClaude = async (transcript) => {
              console.log('=== CALLING CLAUDE ===', transcript);
              setIsAnalyzing(true);

              try {
                const response = await fetch(`${API_URL}/api/analyze-memo`, {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({ transcript })
                });

                console.log('=== CLAUDE RESPONSE STATUS ===', response.status);
                const data = await response.json();
                console.log('=== CLAUDE DATA ===', data);

                if (data.success) {
                  setClaudeAnalysis(data.analysis);
                  console.log('=== SUCCESS! Setting claudeAnalysis ===', data.analysis);
                } else {
                  setBackendError('Claude failed: ' + data.error);
                }
              } catch (error) {
                console.error('=== CLAUDE ERROR ===', error);
                setBackendError('Claude error: ' + error.message);
              } finally {
                setIsAnalyzing(false);
                console.log('=== CLAUDE DONE ===');
              }
            };

            const scheduleMemo = async () => {
              if (!currentTranscript || !scheduleDate) return alert('Please complete all fields.');
              if (notificationMethod.includes('email') && !userEmail) return alert('Please enter your email.');

              try {
                setIsAnalyzing(true);
                setBackendError(null);
                
                // Save to database
                const response = await fetch(`${API_URL}/api/reminders`, {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({
                    email: userEmail,
                    transcript: currentTranscript,
                    tasks: claudeAnalysis?.tasks || [],
                    emailDraft: claudeAnalysis?.emailDraft || '',
                    scheduledFor: (() => {
                    // Create date in user's local timezone, then convert to UTC
                    const localDate = new Date(`${scheduleDate}T${scheduleTime}`);
                    return localDate.toISOString();
                  })()
                  })
                });

                const data = await response.json();
                if (!data.success) throw new Error(data.error);

                // Add to local state for display
                setMemos([...memos, {
                  id: data.reminder.id,
                  transcript: currentTranscript,
                  scheduledFor: new Date(`${scheduleDate}T${scheduleTime}`),
                  toEmail: userEmail,
                  methods: [...notificationMethod]
                }]);

                setCurrentTranscript('');
                setScheduleDate('');
                setUserEmail('');
                setClaudeAnalysis(null);
                setScheduleSuccess(true);
                setShowToast(true);
                setTimeout(() => {
                  setShowToast(false);
                  setScheduleSuccess(false);
                }, 4000);

              } catch (error) {
                console.error('‚ùå Error scheduling:', error);
                setBackendError(`‚ùå Failed to schedule: ${error.message}`);
              } finally {
                setIsAnalyzing(false);
              }
            };

            const isDisabled = () => {
              if (!currentTranscript || !scheduleDate) return true;
              if (notificationMethod.includes('email') && !userEmail) return true;
              if (notificationMethod.includes('sms') && !phoneNumber) return true;
              return false;
            };

            const formatDate = (date) => new Date(date).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
            const formatTime = (s) => `${Math.floor(s/60)}:${String(s%60).padStart(2,'0')}`;

            return (
              <div className={isDarkMode ? 'bg-gray-950 text-white min-h-screen' : 'bg-white min-h-screen'}>
                {showToast && (
                  <div className="fixed top-6 left-1/2 transform -translate-x-1/2 md:left-auto md:translate-x-0 md:right-6 bg-green-500 text-white px-6 py-4 rounded-lg shadow-lg z-50 text-center">
                    ‚úÖ Reminder scheduled! You'll receive an email at the scheduled time.
                  </div>
                )}

                <header className={`border-b ${isDarkMode ? 'border-gray-800' : 'border-gray-100'} px-6 py-6`}>
                  <div className="max-w-3xl mx-auto flex justify-between items-center">
                    <h1 className="text-2xl font-semibold">TaskWhisper</h1>
                    <button onClick={() => setIsDarkMode(!isDarkMode)} className={`p-2 rounded-full ${isDarkMode ? 'hover:bg-gray-800' : 'hover:bg-gray-100'}`}>
                      {isDarkMode ? '‚òÄÔ∏è' : 'üåô'}
                    </button>
                  </div>
                </header>

                <main className="max-w-3xl mx-auto px-6 py-16">
                  <div className="mb-20 text-center">
                    <h2 className="text-5xl font-bold mb-6">
                      Capture a thought.<br/>Turn it into an email reminder.
                    </h2>
                    <p className={`text-xl ${isDarkMode ? 'text-gray-400' : 'text-gray-600'}`}>
                      Record a voice memo and schedule when you need to hear it again.
                    </p>
                  </div>

                  {backendError && (
                    <div className={`mb-8 p-4 rounded-lg ${isDarkMode ? 'bg-yellow-900 text-yellow-200' : 'bg-yellow-50 text-yellow-800'} border ${isDarkMode ? 'border-yellow-700' : 'border-yellow-200'}`}>
                      {backendError}
                    </div>
                  )}

                  <div className={`mb-16 p-12 rounded-2xl ${isDarkMode ? 'bg-gray-900 border border-gray-800' : 'bg-gray-50 border border-gray-100'}`}>
                    <div className="flex flex-col items-center">
                      <button
                        onClick={isRecording ? stopRecording : startRecording}
                        className={`w-28 h-28 rounded-full flex items-center justify-center shadow-lg hover:shadow-xl hover:scale-105 transition-all ${isRecording ? 'bg-red-500 animate-pulse' : 'bg-indigo-600 hover:bg-indigo-700'}`}
                      >
                        <span className="text-white text-4xl">{isRecording ? '‚èπ' : 'üé§'}</span>
                      </button>

                      {isRecording && <div className="mt-6 text-3xl text-red-500">{formatTime(recordingTime)}</div>}

                      <p className={`mt-6 text-lg ${isDarkMode ? 'text-gray-400' : 'text-gray-600'}`}>
                        {isRecording ? 'Recording...' : 'Tap to start recording'}
                      </p>
                      <p className={`mt-2 text-sm ${isDarkMode ? 'text-gray-500' : 'text-gray-500'}`}>
                        {!isRecording && 'Allow microphone access when prompted'}
                      </p>
                    </div>

                    {isTranscribing && (
                      <div className={`mt-10 pt-10 border-t ${isDarkMode ? 'border-gray-800' : 'border-gray-200'} text-center`}>
                        <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-600 mx-auto"></div>
                        <p className="mt-3">Transcribing with Whisper AI...</p>
                      </div>
                    )}

                    {currentTranscript && !isTranscribing && (
                      <div className={`mt-10 pt-10 border-t ${isDarkMode ? 'border-gray-800' : 'border-gray-200'}`}>
                        <div className="flex justify-between items-center mb-4">
                          <h3 className="text-sm font-semibold uppercase text-gray-500">Transcription</h3>
                          <button
                            onClick={() => setIsEditingTranscript(!isEditingTranscript)}
                            className={`px-3 py-1.5 rounded-lg text-sm ${isDarkMode ? 'bg-gray-800 hover:bg-gray-700' : 'bg-gray-200 hover:bg-gray-300'}`}
                          >
                            {isEditingTranscript ? '‚úì Done' : '‚úèÔ∏è Edit'}
                          </button>
                        </div>
                        {isEditingTranscript ? (
                          <textarea
                            value={currentTranscript}
                            onChange={(e) => setCurrentTranscript(e.target.value)}
                            className={`w-full text-lg p-4 rounded-lg border-2 min-h-32 ${isDarkMode ? 'bg-gray-800 border-indigo-500 text-white' : 'bg-white border-indigo-600'}`}
                          />
                        ) : (
                          <p className="text-lg leading-relaxed">{currentTranscript}</p>
                        )}
                      </div>
                    )}

                    {isAnalyzing && (
                      <div className={`mt-10 pt-10 border-t ${isDarkMode ? 'border-gray-800' : 'border-gray-200'}`}>
                        <div className="flex items-center justify-center">
                          <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-purple-600 mr-3"></div>
                          <p className={`font-medium ${isDarkMode ? 'text-purple-400' : 'text-purple-700'}`}>Claude is analyzing your memo...</p>
                        </div>
                      </div>
                    )}

                    {claudeAnalysis && !isAnalyzing && (
                      <div className={`mt-10 pt-10 border-t ${isDarkMode ? 'border-gray-800' : 'border-gray-200'}`}>
                        <h3 className={`text-xl font-bold mb-6 ${isDarkMode ? 'text-purple-400' : 'text-purple-900'}`}>üß† Claude's Analysis</h3>

                        <div className="mb-6">
                          <h4 className={`font-semibold mb-3 ${isDarkMode ? 'text-gray-300' : 'text-gray-800'}`}>üìã Tasks Found:</h4>
                          {claudeAnalysis.tasks.map((task, index) => (
                            <div key={index} className={`p-4 rounded-lg mb-3 ${isDarkMode ? 'bg-gray-800 border border-gray-700' : 'bg-white border border-gray-200'}`}>
                              <p className={`font-medium mb-2 ${isDarkMode ? 'text-gray-100' : 'text-gray-900'}`}>{task.description}</p>
                              <div className="flex gap-3 text-sm flex-wrap">
                                <span className={isDarkMode ? 'text-gray-400' : 'text-gray-600'}>üìÖ {task.suggestedDate}</span>
                                <span className={`px-2 py-1 rounded ${
                                  task.priority === 'urgent' ? 'bg-red-100 text-red-700' :
                                  task.priority === 'normal' ? 'bg-blue-100 text-blue-700' :
                                  'bg-gray-100 text-gray-700'
                                }`}>
                                  {task.priority}
                                </span>
                                <span className={isDarkMode ? 'text-gray-400' : 'text-gray-500'}>üè∑Ô∏è {task.category}</span>
                              </div>
                            </div>
                          ))}
                        </div>

                        <div className={`p-4 rounded-lg ${isDarkMode ? 'bg-gray-800 border border-gray-700' : 'bg-white border border-gray-200'}`}>
                          <h4 className={`font-semibold mb-2 ${isDarkMode ? 'text-gray-300' : 'text-gray-800'}`}>‚úâÔ∏è Email Draft:</h4>
                          <p className={`italic mb-4 ${isDarkMode ? 'text-gray-300' : 'text-gray-700'}`}>{claudeAnalysis.emailDraft}</p>
                          
                          <div className="flex gap-3 mb-3">
                            <input
                              type="email"
                              value={userEmail || 'jay.p.wadhwani@gmail.com'}
                              onChange={(e) => setUserEmail(e.target.value)}
                              placeholder="Enter your email to send"
                              className={`flex-1 px-4 py-2 rounded-lg border ${isDarkMode ? 'bg-gray-700 border-gray-600 text-white' : 'bg-white border-gray-300'}`}
                            />
                            <button
                              onClick={async () => {
                                const emailToSend = userEmail || 'jay.p.wadhwani@gmail.com';
                                
                                try {
                                  setIsAnalyzing(true);
                                  setBackendError('üìß Sending email...');
                                  
                                  const emailResponse = await fetch(`${API_URL}/api/send-email`, {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify({
                                      to: emailToSend,
                                      from: 'noreply@jaypwadhwani.com',
                                      subject: 'TaskWhisper Reminder - Your Tasks',
                                      emailBody: claudeAnalysis.emailDraft,
                                      tasks: claudeAnalysis.tasks
                                    })
                                  });

                                  const emailData = await emailResponse.json();
                                  
                                  if (!emailData.success) {
                                    throw new Error(emailData.error);
                                  }

                                  console.log('‚úÖ Email sent!', emailData);
                                  setBackendError('‚úÖ Email sent successfully! Check your inbox (including spam folder).');
                                  setTimeout(() => setBackendError(null), 8000);
                                } catch (error) {
                                  console.error('‚ùå Email error:', error);
                                  setBackendError(`‚ùå Failed to send: ${error.message}`);
                                } finally {
                                  setIsAnalyzing(false);
                                }
                              }}
                              disabled={isAnalyzing}
                              className={`px-6 py-2 rounded-lg font-medium transition-colors ${
                                isAnalyzing 
                                  ? 'bg-purple-400 cursor-wait text-white' 
                                  : 'bg-purple-600 hover:bg-purple-700 text-white'
                              }`}
                            >
                              {isAnalyzing ? '‚è≥ Sending...' : 'üìß Send Immediately'}
                            </button>
                          </div>
                          
                          {backendError && backendError.includes('Email') && (
                            <div className={`p-3 rounded-lg text-sm ${
                              backendError.includes('‚úÖ') 
                                ? 'bg-green-100 text-green-800 border border-green-200' 
                                : backendError.includes('üìß') 
                                ? 'bg-blue-100 text-blue-800 border border-blue-200'
                                : 'bg-red-100 text-red-800 border border-red-200'
                            }`}>
                              {backendError}
                            </div>
                          )}
                        </div>
                      </div>
                    )}
                  </div>

                  {currentTranscript && !isTranscribing && (
                    <div ref={scheduleRef} className={`mb-16 p-12 rounded-2xl ${isDarkMode ? 'bg-gray-900 border border-gray-800' : 'bg-gray-50 border border-gray-100'}`}>
                      <h3 className="text-2xl font-semibold mb-8">üìÖ Schedule your reminder</h3>

                      <div className="mb-6">
                        <label className="block text-sm font-medium mb-3">Notification method</label>
                        <div className="flex gap-3">
                          {['email', 'sms'].map(method => (
                            <button
                              key={method}
                              onClick={() => {
                                if (notificationMethod.includes(method)) {
                                  if (notificationMethod.length > 1) setNotificationMethod(notificationMethod.filter(m => m !== method));
                                } else {
                                  setNotificationMethod([...notificationMethod, method]);
                                }
                              }}
                              className={`flex-1 px-4 py-3 rounded-lg border-2 ${notificationMethod.includes(method) ? 'border-indigo-600 bg-indigo-50 text-indigo-600' : 'border-gray-300'}`}
                            >
                              {method === 'email' ? 'üìß Email' : 'üí¨ SMS'}
                            </button>
                          ))}
                        </div>
                      </div>

                      {notificationMethod.includes('email') && (
                        <div className="mb-6">
                          <label className="block text-sm font-medium mb-3">Send reminder to</label>
                            <input
                              type="email"
                              value={userEmail}
                              onChange={(e) => setUserEmail(e.target.value)}
                              placeholder="your-email@example.com"
                              className={`w-full px-4 py-3 rounded-lg border ${isDarkMode ? 'bg-gray-800 border-gray-700' : 'bg-white border-gray-300'}`}
                            />
                        </div>
                      )}

                      {notificationMethod.includes('sms') && (
                        <div className="mb-6">
                          <label className="block text-sm font-medium mb-3">Phone number</label>
                          <input
                            type="tel"
                            value={phoneNumber}
                            onChange={(e) => setPhoneNumber(e.target.value)}
                            placeholder="+1 (555) 123-4567"
                            className={`w-full px-4 py-3 rounded-lg border ${isDarkMode ? 'bg-gray-800 border-gray-700' : 'bg-white border-gray-300'}`}
                          />
                        </div>
                      )}

                      <div className="mb-6">
                        <label className="block text-sm font-medium mb-3">Date & Time</label>
                        <div className="flex flex-col md:flex-row gap-3">
                          <input
                            type="date"
                            value={scheduleDate}
                            onChange={(e) => setScheduleDate(e.target.value)}
                            className={`flex-1 px-4 py-3 rounded-lg border ${isDarkMode ? 'bg-gray-800 border-gray-700' : 'bg-white border-gray-300'}`}
                          />
                          <input
                            type="time"
                            value={scheduleTime}
                            onChange={(e) => setScheduleTime(e.target.value)}
                            className={`flex-1 px-4 py-3 rounded-lg border ${isDarkMode ? 'bg-gray-800 border-gray-700' : 'bg-white border-gray-300'}`}
                          />
                        </div>
                      </div>

                      {scheduleSuccess ? (
                        <div className="w-full py-4 rounded-lg font-medium text-lg bg-green-500 text-white text-center">
                          ‚úÖ Reminder Scheduled!
                        </div>
                      ) : (
                        <button
                          onClick={scheduleMemo}
                          disabled={isDisabled() || isAnalyzing}
                          className={`w-full py-4 rounded-lg font-medium text-lg ${isDisabled() || isAnalyzing ? 'bg-gray-200 text-gray-400 cursor-not-allowed' : 'bg-indigo-600 hover:bg-indigo-700 text-white'}`}
                        >
                          {isAnalyzing ? '‚è≥ Scheduling...' : 'üìÖ Schedule Reminder'}
                        </button>
                      )}
                    </div>
                  )}

                  {memos.length > 0 && (
                    <div>
                      <h3 className="text-2xl font-semibold mb-8">üïê Your scheduled reminders</h3>
                      <div className="space-y-4">
                        {memos.map(memo => (
                          <div key={memo.id} className={`p-8 rounded-2xl ${isDarkMode ? 'bg-gray-900 border border-gray-800' : 'bg-gray-50 border border-gray-100'}`}>
                            <div className="flex justify-between">
                              <div className="flex-1">
                                <p className="text-lg mb-4">{memo.transcript}</p>
                                <p className="text-sm text-gray-500">
                                  üìÖ {formatDate(memo.scheduledFor)} ‚Ä¢ {memo.methods.join(', ')}
                                  {memo.toEmail && <span> ‚Ä¢ To: {memo.toEmail}</span>}
                                </p>
                              </div>
                              <button
                                onClick={() => setMemos(memos.filter(m => m.id !== memo.id))}
                                className="text-gray-400 hover:text-red-600 ml-4"
                              >
                                üóëÔ∏è
                              </button>
                            </div>
                          </div>
                        ))}
                      </div>
                    </div>
                  )}
                </main>

                <footer className={`border-t ${isDarkMode ? 'border-gray-800' : 'border-gray-100'} mt-24 py-12 text-center`}>
                  <p className="text-sm text-gray-500">
                    Built as a portfolio project ‚Ä¢ Powered by OpenAI Whisper + Claude AI
                  </p>
                </footer>
              </div>
            );
          }

          ReactDOM.render(<TaskWhisper />, document.getElementById('root'));
    </script>
  </body>
</html>
